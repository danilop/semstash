{% extends "base.html" %}

{% block title %}Chat - SemStash{% endblock %}

{% block content %}
<style>
    .chat-container {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 180px);
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .chat-header {
        padding: 1rem;
        border-bottom: 1px solid var(--gray-200);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .chat-header h2 {
        margin: 0;
        font-size: 1.25rem;
    }

    .chat-header .status {
        font-size: 0.875rem;
        color: var(--gray-500);
    }

    .chat-header .status.connected {
        color: var(--success);
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .message {
        max-width: 80%;
        padding: 0.75rem 1rem;
        border-radius: 0.75rem;
        line-height: 1.5;
    }

    .message.user {
        background: var(--primary);
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 0.25rem;
    }

    .message.assistant {
        background: var(--gray-100);
        color: var(--gray-900);
        align-self: flex-start;
        border-bottom-left-radius: 0.25rem;
    }

    .message.assistant pre {
        background: var(--gray-200);
        padding: 0.5rem;
        border-radius: 0.375rem;
        overflow-x: auto;
        margin: 0.5rem 0;
    }

    .message.assistant code {
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.875rem;
    }

    .message.error {
        background: #fee2e2;
        color: #991b1b;
        align-self: center;
        text-align: center;
    }

    .message.system {
        background: var(--gray-100);
        color: var(--gray-500);
        align-self: center;
        font-size: 0.875rem;
        text-align: center;
    }

    .message .thinking {
        display: inline-block;
        animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .chat-input-container {
        padding: 1rem;
        border-top: 1px solid var(--gray-200);
        background: var(--gray-50);
    }

    .chat-input-form {
        display: flex;
        gap: 0.5rem;
    }

    .chat-input {
        flex: 1;
        padding: 0.75rem 1rem;
        border: 1px solid var(--gray-300);
        border-radius: 0.5rem;
        font-size: 1rem;
        resize: none;
        min-height: 44px;
        max-height: 150px;
        font-family: inherit;
    }

    .chat-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .send-btn {
        padding: 0.75rem 1.5rem;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 0.5rem;
        font-size: 1rem;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s;
    }

    .send-btn:hover:not(:disabled) {
        background: var(--primary-dark);
    }

    .send-btn:disabled {
        background: var(--gray-300);
        cursor: not-allowed;
    }

    .chat-controls {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
        justify-content: space-between;
        align-items: center;
    }

    .chat-controls .hint {
        font-size: 0.75rem;
        color: var(--gray-500);
    }

    .control-btns {
        display: flex;
        gap: 0.5rem;
    }

    .control-btn {
        padding: 0.25rem 0.75rem;
        background: transparent;
        border: 1px solid var(--gray-300);
        border-radius: 0.375rem;
        font-size: 0.75rem;
        color: var(--gray-500);
        cursor: pointer;
        transition: all 0.2s;
    }

    .control-btn:hover {
        background: var(--gray-100);
        border-color: var(--gray-400);
        color: var(--gray-700);
    }

    .welcome-message {
        text-align: center;
        padding: 2rem;
        color: var(--gray-500);
    }

    .welcome-message h3 {
        color: var(--gray-700);
        margin-bottom: 0.5rem;
    }

    .welcome-message p {
        margin-bottom: 1rem;
    }

    .welcome-message .suggestions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        justify-content: center;
        margin-top: 1rem;
    }

    .welcome-message .suggestion {
        padding: 0.5rem 1rem;
        background: var(--gray-100);
        border: 1px solid var(--gray-200);
        border-radius: 0.5rem;
        font-size: 0.875rem;
        color: var(--gray-700);
        cursor: pointer;
        transition: all 0.2s;
    }

    .welcome-message .suggestion:hover {
        background: var(--primary);
        border-color: var(--primary);
        color: white;
    }
</style>

<div class="chat-container">
    <div class="chat-header">
        <div>
            <h2>AI Assistant</h2>
            <span class="status" id="status">Initializing...</span>
        </div>
        <div class="control-btns">
            <button class="control-btn" id="resetBtn" title="Clear conversation">Reset</button>
        </div>
    </div>

    <div class="chat-messages" id="messages">
        <div class="welcome-message" id="welcome">
            <h3>Welcome to SemStash Chat</h3>
            <p>I can help you explore and understand your stored content.</p>
            <p>Try asking:</p>
            <div class="suggestions">
                <button class="suggestion" onclick="askSuggestion(this)">What files are stored?</button>
                <button class="suggestion" onclick="askSuggestion(this)">Search for documents</button>
                <button class="suggestion" onclick="askSuggestion(this)">Show storage statistics</button>
            </div>
        </div>
    </div>

    <div class="chat-input-container">
        <form class="chat-input-form" id="chatForm">
            <textarea
                class="chat-input"
                id="chatInput"
                placeholder="Ask me anything about your stored content..."
                rows="1"
            ></textarea>
            <button type="submit" class="send-btn" id="sendBtn">Send</button>
        </form>
        <div class="chat-controls">
            <span class="hint">Press Enter to send, Shift+Enter for new line</span>
        </div>
    </div>
</div>

<script>
    const messagesContainer = document.getElementById('messages');
    const chatInput = document.getElementById('chatInput');
    const chatForm = document.getElementById('chatForm');
    const sendBtn = document.getElementById('sendBtn');
    const resetBtn = document.getElementById('resetBtn');
    const status = document.getElementById('status');
    const welcome = document.getElementById('welcome');

    let sessionId = null;
    let isProcessing = false;

    // Auto-resize textarea
    chatInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 150) + 'px';
    });

    // Handle Enter key
    chatInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            chatForm.dispatchEvent(new Event('submit'));
        }
    });

    // Initialize session
    async function initSession() {
        try {
            const response = await fetch('/agent/session', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'model_id={{ model_id }}'
            });

            if (!response.ok) {
                throw new Error('Failed to create session');
            }

            const data = await response.json();
            sessionId = data.session_id;
            status.textContent = 'Connected to {{ bucket }}';
            status.classList.add('connected');
        } catch (error) {
            status.textContent = 'Connection error';
            addMessage('error', 'Failed to connect to agent. Please refresh the page.');
        }
    }

    // Add message to chat
    function addMessage(type, content) {
        welcome.style.display = 'none';

        const msg = document.createElement('div');
        msg.className = `message ${type}`;
        msg.innerHTML = formatMessage(content);
        messagesContainer.appendChild(msg);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        return msg;
    }

    // Format message content (basic markdown support)
    function formatMessage(content) {
        // Escape HTML
        let html = content.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

        // Code blocks
        html = html.replace(/```(\w*)\n?([\s\S]*?)```/g, '<pre><code>$2</code></pre>');

        // Inline code
        html = html.replace(/`([^`]+)`/g, '<code>$1</code>');

        // Bold
        html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');

        // Italic
        html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');

        // Line breaks
        html = html.replace(/\n/g, '<br>');

        return html;
    }

    // Send message
    async function sendMessage(message) {
        if (!sessionId || isProcessing || !message.trim()) return;

        isProcessing = true;
        sendBtn.disabled = true;
        chatInput.disabled = true;

        // Add user message
        addMessage('user', message);
        chatInput.value = '';
        chatInput.style.height = 'auto';

        // Add assistant message placeholder
        const assistantMsg = addMessage('assistant', '<span class="thinking">Thinking...</span>');

        try {
            // Use streaming endpoint
            const response = await fetch(`/agent/stream/${sessionId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: message })
            });

            if (!response.ok) {
                throw new Error('Failed to send message');
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let fullResponse = '';

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value);
                const lines = chunk.split('\n');

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.slice(6));

                            if (data.type === 'text') {
                                fullResponse += data.content;
                                assistantMsg.innerHTML = formatMessage(fullResponse);
                                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                            } else if (data.type === 'error') {
                                assistantMsg.innerHTML = formatMessage(fullResponse || 'An error occurred: ' + data.message);
                                assistantMsg.classList.add('error');
                            } else if (data.type === 'done') {
                                if (!fullResponse) {
                                    assistantMsg.innerHTML = '<em>No response generated</em>';
                                }
                            }
                        } catch (e) {
                            // Ignore JSON parse errors for partial data
                        }
                    }
                }
            }

        } catch (error) {
            assistantMsg.innerHTML = 'Error: ' + error.message;
            assistantMsg.classList.remove('assistant');
            assistantMsg.classList.add('error');
        }

        isProcessing = false;
        sendBtn.disabled = false;
        chatInput.disabled = false;
        chatInput.focus();
    }

    // Reset conversation
    async function resetConversation() {
        if (!sessionId) return;

        try {
            await fetch(`/agent/reset/${sessionId}`, { method: 'POST' });

            // Clear messages
            messagesContainer.innerHTML = '';
            welcome.style.display = 'block';
            messagesContainer.appendChild(welcome);

            addMessage('system', 'Conversation reset');
        } catch (error) {
            addMessage('error', 'Failed to reset conversation');
        }
    }

    // Ask suggestion
    function askSuggestion(btn) {
        chatInput.value = btn.textContent;
        chatForm.dispatchEvent(new Event('submit'));
    }

    // Form submit
    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        sendMessage(chatInput.value);
    });

    // Reset button
    resetBtn.addEventListener('click', resetConversation);

    // Initialize on load
    initSession();
</script>
{% endblock %}
